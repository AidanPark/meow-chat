version: "3.9"

services:
  backend-mcp:
    build:
      context: .
      dockerfile: backend/Dockerfile
    container_name: meowchat-backend-mcp
    environment:
      - DOCKER=1
      # Global defaults (optional)
      - MCP_HOST=${MCP_HOST:-0.0.0.0}
      - MCP_PORT=${MCP_PORT:-}
      # Per-server overrides
      - MCP_MATH_UTILITY_HOST=${MCP_MATH_UTILITY_HOST:-0.0.0.0}
      - MCP_MATH_UTILITY_PORT=${MCP_MATH_UTILITY_PORT:-8000}
      - MCP_WEATHER_API_HOST=${MCP_WEATHER_API_HOST:-0.0.0.0}
      - MCP_WEATHER_API_PORT=${MCP_WEATHER_API_PORT:-8001}
      - MCP_CAT_HEALTH_HOST=${MCP_CAT_HEALTH_HOST:-0.0.0.0}
      - MCP_CAT_HEALTH_PORT=${MCP_CAT_HEALTH_PORT:-8002}
      - MCP_EXTRACT_LAB_REPORT_HOST=${MCP_EXTRACT_LAB_REPORT_HOST:-0.0.0.0}
      - MCP_EXTRACT_LAB_REPORT_PORT=${MCP_EXTRACT_LAB_REPORT_PORT:-8004}
      - MCP_MEMORY_HOST=${MCP_MEMORY_HOST:-0.0.0.0}
      - MCP_MEMORY_PORT=${MCP_MEMORY_PORT:-8005}
    ports:
      # Map host:container port using the same value so overrides stay in sync
      - "${MCP_MATH_UTILITY_PORT:-8000}:${MCP_MATH_UTILITY_PORT:-8000}"
      - "${MCP_WEATHER_API_PORT:-8001}:${MCP_WEATHER_API_PORT:-8001}"
      - "${MCP_CAT_HEALTH_PORT:-8002}:${MCP_CAT_HEALTH_PORT:-8002}"
      - "${MCP_EXTRACT_LAB_REPORT_PORT:-8004}:${MCP_EXTRACT_LAB_REPORT_PORT:-8004}"
      - "${MCP_MEMORY_PORT:-8005}:${MCP_MEMORY_PORT:-8005}"
    volumes:
      - ./:/workspace
    working_dir: /workspace
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: meowchat-frontend
    environment:
      - DOCKER=1
    ports:
      - "8501:8501"
    volumes:
      - ./:/workspace
      # Override MCP config inside container to talk to backend-mcp service name
      - ./frontend/config/mcp_servers.docker.yml:/workspace/frontend/config/mcp_servers.yml:ro
    working_dir: /workspace
    depends_on:
      - backend-mcp
    restart: unless-stopped
