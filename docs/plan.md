# meow-chat 계획(간단 버전): 냥닥터

> **최종 업데이트**: 2026-01-03  
> **현재 목표**: Step 6(게이트)까지 최단 루트로 도달  
> **현재 상태**: Step 5 (검사 분석) 진행 중 ⏳

---

## 현재 진행 현황 (한눈에)

### ✅ 완료(Phase 1)
- Step 1~4: 스몰톡/세션 히스토리/문서 업로드+OCR/단일 Send UX
- Step 4.5(A): form 기반 단일 Send
- Step 4.5(A+) MVP+ 최소범위
  - ✅ 현재 문서 표시(기억 UX)
  - ✅ OCR 캐싱(키=`sha256(file_bytes):ocr_provider` + 캐시 히트 표시)
  - ✅ 단계 표시(업로드→OCR→의도분류→응답)
  - ✅ 스트리밍 저장 규칙(완료 후 최종 1개만 저장)
- 오케스트레이션 레이어(프레임워크 없이)
  - ✅ IntentClassifier(의도분류), Router, Responder 분리
  - ✅ 모델 분리: intent=gpt-5-nano, chat=gpt-5-mini, analysis=gpt-4.1
- **Step 4.x-1: 모바일 입력 UX (갤러리 + 카메라)** ✅ 완료
  - ✅ `st.camera_input` 추가
  - ✅ 모바일 갤러리 선택 지원
  - ✅ OCR 파이프라인 연결
- **Step 4.x: 멀티파일/PDF 다페이지** ✅ 대부분 완료
  - ✅ 멀티파일 업로드 (`accept_multiple_files=True`)
  - ✅ PDF 다페이지 처리 (최대 10페이지)
  - ✅ 페이지별 OCR + 스마트 병합 (`LabReportExtractor.merge_extractions`)
  - ✅ 문서 묶음 캐싱 (bytes 해시 기반)
  - ✅ 파일 5개 상한 적용
  - ✅ 모든 이미지 표시 UI
  - ✅ 노트북 스타일 검사 결과 표시 (헤더 + 테이블)

### ▶️ 다음(지금 할 일)
- **Step 5 — 검사 분석(문서 컨텍스트 기반 상담) ⏳**
  - 목표: 실제 결과지로 "업로드→분석 질문→분석 답변" 검증
  - 완료 조건:
    - [ ] 실제 결과지 1~2개에서 분석 요청 시 문서 컨텍스트가 답변에 반영됨 확인
    - [ ] 안전장치 유지 확인 (진단/처방 금지, 응급 시 병원 권유, 참고용 고지)
    - [ ] 멀티파일 병합 결과가 분석에 정상 반영됨 확인

### ⏭️ Phase 2(1차 고도화로 이관)
- 재실행 버튼(질문만/OCR부터), ChatGPT급 첨부 UX
- 의도분류 고도화(멀티 라벨, confidence 기반 재질문, 툴 라우팅)
- 로그인/개인화 장기 기억 저장/조회
- 비동기 큐/멀티페이지 PDF

---

## Step 4.x — 검사지 여러장 처리(최소 기능, 필수)  ✅ 완료

**목표**: 멀티페이지 PDF/복수 이미지(2장+)를 단일 "문서 컨텍스트"로 병합해 분석 가능하게 한다.

**추가 목표(최소 배포 요구: 모바일)**
- 파일첨부뿐 아니라, **모바일에서 갤러리 사진 선택 / 카메라 촬영 업로드**가 가능해야 한다.
  - 참고: `tests/streamlit_camera_demo.py`

### 완료된 주요 기능
- ✅ 모바일 카메라 촬영 + 갤러리 선택
- ✅ 멀티파일 업로드 (최대 5개)
- ✅ PDF 다페이지 처리 (최대 10페이지)
- ✅ 페이지별 OCR + 스마트 병합
- ✅ 모든 이미지 UI 표시
- ✅ 노트북 스타일 검사 결과 표시
- ✅ 문서 묶음 캐싱

### Step 4.x-1 (우선) — 모바일 입력 UX(갤러리 + 카메라) 먼저 앱에 반영 ✅ 완료

> 목표: 사용자가 휴대폰에서 바로 "사진 선택" 또는 "촬영"으로 결과지를 넣을 수 있게 한다.
> 이 단계에서는 "여러 장 병합"까지 밀어붙이지 않고, **기존 단일 문서 업로드 파이프라인에 입력만 연결**하는 것을 완료 기준으로 한다.

#### 완료 조건(앱)
- [x] `app/Home.py`에 `st.camera_input` 추가 후 촬영 이미지가 OCR 파이프라인으로 들어간다
- [x] `st.file_uploader`로 모바일 갤러리에서 선택한 이미지도 OCR 파이프라인으로 들어간다
- [x] 업로드/촬영 후 "현재 문서 표시(기억 UX)"가 유지된다
- [x] (선택) 촬영/갤러리 입력을 했을 때 오류 메시지가 사용자 친화적으로 표시된다

#### 구현 메모
- Streamlit 모바일에서 갤러리 선택은 기본적으로 `st.file_uploader`가 담당
- 카메라 촬영은 `st.camera_input` 사용
- 우선은 "단일 이미지 입력"만 보장하고, 멀티파일/병합은 다음 단계로 확장

#### 범위에서 제외(다음 단계로)
- (다중 입력) 여러 장 업로드/병합/캐싱 확장
- (PDF) 다페이지 처리
- (노트북) 병합 검증

#### 검증(데모)
- [x] `tests/streamlit_camera_demo.py` 동작 확인
- [x] 데모 입력(촬영/갤러리)을 `app/Home.py` 파이프라인에 연결 가능함을 확인

### Step 4.x (앱 반영) — PDF 다페이지 + 여러 파일 업로드/분석 (최단 루트, Step 5 정확도용)

> 위 Step 4.x-1(모바일 입력 UX) 완료 후 진행.

> 원래 메모: “Streamlit 앱 반영은 Step 6 이후 Phase 2에서 진행(가능)”
>
> 🔥 최단 루트 정책: Phase 2의 비동기/고급 UX는 유지하되, Step 5(분석) 정확도를 위해 **지금은 동기 방식으로 ‘여러 장 → 단일 문서 컨텍스트’ 병합만** 먼저 앱에 반영한다.

#### 정의(스코프)
- 입력: **복수 이미지 +/or 멀티페이지 PDF**
- 처리: 파일/페이지 순서대로 OCR → 텍스트/구조화 결과를 병합
- 출력: 기존 “단일 문서 컨텍스트(기억 UX)”를 유지하되, 컨텍스트가 여러 장을 포함

#### 코딩 체크리스트: 앱 입력(업로드)
- [x] `app/Home.py`: `st.file_uploader`를 `accept_multiple_files=True`로 전환
- [x] `st.camera_input` 위젯 추가 (카메라 촬영 지원)
  - 참고: `tests/streamlit_camera_demo.py`
  - 파일 업로더와 병행 사용 가능하도록 처리 (촬영된 이미지를 입력 리스트에 추가)
- [x] 업로드 상한(총 5개 파일) 적용 위치를 명시
  - 권장: 업로더/카메라 입력을 합친 "입력 리스트" 기준으로 5개 제한
  - 상한 초과 입력은 즉시 경고 후 분석 버튼 비활성화 또는 초과분 무시(정책 택1)
- [x] 타입은 기존 유지: jpg/jpeg/png/webp/pdf
- [x] 파일 순서 정책을 명시/고정 (택1)
  - [x] A(최단): 업로드된 순서 그대로 처리 (선택됨)
  - [ ] B(안전): 파일명 정렬 후 처리 (권장)
- [x] UI에 "총 N개 파일 / PDF는 페이지별 처리" 표시

#### 코딩 체크리스트: PDF 다페이지 + 멀티파일 OCR 병합(로직)
- [x] `src/`에 "업로드 입력 → 페이지 이미지 리스트" 표준화 유틸 추가
  - [x] 이미지: bytes → PIL.Image 1장
  - [x] PDF: bytes → PIL.Image N장 (`pdf_bytes_to_images` 사용)
- [x] 처리 루프: (파일) × (페이지) 단위로 OCR 실행
- [x] 다페이지 PDF의 페이지 상한/정책을 명시 (Phase 2 전 임시)
  - 예: PDF는 최대 10페이지까지만 처리, 나머지는 경고 표시
- [x] 병합 텍스트에 파일/페이지 경계 구분자 삽입(디버깅/LLM 안정성)
  - 예: `--- file:{name} page:{i}/{n} ---`
- [x] (최단) 프리뷰는 대표 1장만 유지(첫 파일의 첫 페이지)
- [x] (가능하면) 페이지/파일 메타 저장
  - 예: 파일 목록, 총 페이지 수, 실패 페이지 목록

#### 코딩 체크리스트: 구조화/병합 (노트북 파이프라인 앱 이식)
- [x] 페이지별 extraction 결과 리스트를 수집
- [x] `LabReportExtractor.merge_extractions(extractions)`로 스마트 병합
  - 기대: header_shape + inspection_date 규칙으로 같은 문서로 판단되면 tests가 합쳐짐
- [x] 최종 병합 결과를 "분석 컨텍스트"로 사용
- [x] (중요) 분석 응답 생성 시 실제로 `LAB_ANALYSIS_SYSTEM_PROMPT`를 사용 중인지 확인
  - 현재 사용처: `src/services/orchestration/lab_analysis_responder.py`

#### 검증(노트북)
- [ ] 노트북: "PDF 2페이지" 샘플로 전체 텍스트 병합→구조화→분석 프롬프트 입력까지 확인
- [ ] 노트북: "이미지 2장" 샘플로 전체 텍스트 병합→구조화→분석 프롬프트 입력까지 확인

#### 코딩 체크리스트: 캐싱/중복 실행
- [x] 기존 OCR 캐시 키(`sha256(file_bytes):provider`)를 "문서 묶음" 단위로 확장
  - 예: `sha256(concat(file_hashes_in_order)):provider`
  - 순서까지 캐시 키에 포함할지(권장: 포함) 결정
- [x] (중요) 문서 묶음 캐시 키 만들 때 "파일명"은 제외하고 bytes 기반 해시만 사용 (재현성)

#### 코딩 체크리스트: 실패 처리/가드레일(성능/UX)
- [x] 부분 실패 정책(택1)
  - [ ] A(최단): 한 페이지 실패 시 전체 실패 처리
  - [x] B(권장): 실패 페이지 스킵 + 경고 누적 ("N페이지 중 M페이지 실패")
- [ ] 실패/스킵된 페이지가 있다면 분석 프롬프트 입력에 "누락可能"을 명시(안전장치)
- [x] 임시 상한(Phase 2 이전 안전장치)
  - [x] 총 파일 수 상한: 5개 (선택됨)
  - [x] 상한 초과 시 안내: "대용량/비동기는 Phase 2로 이관"

#### Phase 2로 이관할 항목(명시)
- [ ] 페이지 단위 진행률/취소/재시도
- [ ] 페이지 미리보기/재정렬/선택 OCR
- [ ] 백그라운드 OCR(큐/워커), 대용량 최적화

---

## Step 5 — 검사 분석(문서 컨텍스트 기반 상담)  ✅ 구현 완료 / 검증 대기 중

**목표**: 업로드된 검사 결과(ocr_text/structured)를 컨텍스트로 분석 답변 생성

**완료된 구현**
- ✅ OCR 추출 데이터가 LLM 컨텍스트로 전달됨
- ✅ `LAB_ANALYSIS_SYSTEM_PROMPT` 적용 (`src/prompts/lab_analysis.py`)
- ✅ 멀티파일 병합 결과가 분석 컨텍스트로 사용됨
- ✅ 노트북 스타일 검사 결과 표시 (📷 분석 이미지 + 🧾 검사 결과 데이터 + 🩺 AI 분석 해석)
- ✅ 안전장치 프롬프트 포함 (진단/처방 금지, 응급 시 병원 권유, 참고용 고지)

**검증 필요 (형님 확인)**
- [ ] 실제 결과지 1~2개에서 분석 요청 시 문서 컨텍스트가 답변에 잘 반영되는지 확인
- [ ] LLM 응답에 안전장치 문구가 잘 포함되는지 확인
- [ ] 멀티파일 업로드 시 모든 페이지 데이터가 분석에 반영되는지 확인

**완료 조건(최단 루트)**
- [ ] 실제 결과지 1~2개로 테스트하여 정상 동작 확인
- [ ] 안전장치 유지(진단/처방 금지, 불확실성, 응급 시 병원 권유, 참고용 고지) 확인

---

## Step 6 — (게이트) 프레임워크 도입 여부 결정  ⏳

> **형님 선택(A): 1인 개발/소규모 사용자 전제(당분간)**

**목표**: Phase 2에서 LangGraph/서빙 분리/DB/RAG 도입이 필요한지 Yes/No 결정

**선행 조건**
- [ ] Step 1~5 완료(특히 Step 5 실제 결과지 통과)

**타임박스**: 30~60분

**결정 질문(예/아니오 체크)**
- [ ] Streamlit ↔ API 분리가 지금 필요한가?
- [ ] 비동기(큐/백그라운드 작업)가 지금 필요한가?
- [ ] Phase 2에서 RAG(출처/검색)가 필요한가?
- [ ] LangGraph 같은 오케스트레이션이 지금 이득인가?
- [ ] 로그인/장기기억 저장이 곧 필요한가?

**산출물(5줄만 기록하면 끝)**
- 결론: Streamlit 유지 | API 분리 | API+Worker+Queue
- 오케스트레이션: Router 유지 | LangGraph 도입
- 저장/개인화: 세션만 | DB 도입
- RAG: 미도입 | 도입
- Phase 2 첫 3개 티켓

**기본 추천 결론(A 기준)**
- 당분간은 Streamlit 유지 + Router/서비스 레이어 확장

---

## 참고(설계 원칙 요약)
- UI(`app/`) ↔ 로직(`src/`) 분리 유지
- 외부 의존성(LLM/OCR)은 Provider 패턴으로 격리
- “검사지 1회 업로드 = 문서 컨텍스트 유지(기억 UX)”를 기본으로
