# 검사결과 데이터로 “수의사 수준” 설명 생성 플로우

본 문서는 랩 리포트(검사결과)로부터 수의사 수준의 한국어 임상 설명을 안정적으로 생성하는 전체 흐름을 요약한 자료입니다. 

---

## 1. 목표와 성공 기준

- 목표
  - 추출된 랩 결과(MergeEnvelope JSON)로부터 수의사 수준의 해석(이상 판정, 병태생리 추정, 감별진단 후보, 권장 추가검사/관리)을 생성합니다.
  - 숫자 해석은 규칙으로 일관성 있게 보장하고, 배경 설명은 문헌/가이드라인을 인용(RAG)하여 신뢰성을 높이며, LLM은 자연스러운 한국어 임상 설명만 담당하도록 역할을 분리합니다.
- 성공 기준
  - 동일 입력에 대해 반복 가능한(일관된) 판정
  - 수치/단위/참고범위 오독 최소화
  - 응급/중증 임계값에서 적시에 경고 문구 출력
  - 근거 인용(출처/섹션) 표기

---

## 2. 전체 플로우(개요)

```text
이미지/PDF → [OCR 추출] → MergeEnvelope(JSON)
                 │
                 ▼
        [규칙 기반 1차 해석] → facts(JSON: abnormalities, patterns, recommendations, caveats)
                 │
                 ▼
           [RAG 근거 생성] → evidence(JSON: snippet, source, section)
                 │
                 ▼
        [LLM 합성(수의사 톤)] → 최종 응답(요약, 표, 해석, 권장 검사/관리, 한계, 인용)
```

핵심 아이디어: “판정은 규칙, 설명은 LLM, 신뢰는 근거 인용”으로 역할을 명확히 분리합니다.

---

## 3. 입력/출력 계약(Contract)

- 입력(JSON: MergeEnvelope)
  - stage: "merge"
  - data.merged: 문서/테스트 리스트
    - 문서 메타: hospital_name, patient_name, inspection_date, header_shape(선택)
    - tests: [{ code, value, unit, reference_min, reference_max, (선택) name, meaning }]
- 중간 산출물(JSON: facts)
  - abnormalities: [{code, value, unit, ref_min, ref_max, direction, severity, notes}]
  - patterns: [{label, evidence_tests, confidence}]
  - recommendations: [{type: lab|imaging|history|exam, rationale, priority}]
  - caveats: [결측/단위의심/범위불명]
- 중간 산출물(JSON: evidence)
  - [{snippet, source, page_or_section, relevance}]
- 출력(최종 응답 텍스트)
  - 상단 요약(핵심 결론 1–2문장)
  - 이상 항목 표(값/단위/참고범위/방향/중증도)
  - 임상 해석(병태생리/감별진단/연계 소견)
  - 권장 추가검사/관리(우선순위/긴급성)
  - 근거/한계(숫자·규칙·문헌 인용)

---

## 4. 단계별 상세

### 4-1. OCR 추출 → MergeEnvelope(JSON)
- 검사지 이미지/PDF에서 표/텍스트를 구조화하여 `MergeEnvelope`로 정규화합니다.
- 단위·참고범위는 가능한 리포트 원본을 우선 채택합니다.

### 4-2. 규칙 기반 1차 해석(필수) → facts(JSON)
- 단일 항목 임계 판정 예시
  - PLT < min → "혈소판 감소증 의심"
  - HGB/HCT < min → "빈혈 의심"
- 조합 규칙(패턴) 예시
  - RBC/HGB/HCT 동시 저하 + MCV/MCHC로 빈혈 형태 분류(소구성/대구성/저색소성 등)
  - WBC, NEUT/LYMPH/Mono 조합으로 염증/감염 방향성 추정
  - CREA/BUN/USG(있다면)로 신장 기능 이상/범주(전·신·후신성) 시사
- 중증도 등급 예시
  - PLT: <50 K/µL(중증, 출혈 위험), 50–150(경~중등)
  - PCV/HCT: <15%(응급), 15–24%(중등도), 24–28%(경도)

### 4-3. RAG 기반 근거 인용 → evidence(JSON)
- 로컬 KB 소스 예시: guidelines, medical_papers, veterinary_docs
- 인덱싱: 문단/문장 단위 분할 → 임베딩 → 벡터 스토어(Chroma)
- 검색 쿼리: facts로부터 key_terms 생성(예: "thrombocytopenia in cats")
- 산출물: 스니펫 + 출처 + 섹션/페이지 + 관련도

### 4-4. LLM 합성(수의사 톤) → 최종 응답
- 입력: merge 요약(표), facts, evidence
- 지침(요지)
  - 과장 금지, 숫자·단위·범위 정확히
  - 근거/한계/불확실성 명시(장비/검체/범위 출처 차이)
  - 보호자 관점: 위험도·우선순위·다음 행동 제시
- 출력 구성
  1) 핵심 요약(1–2문장)
  2) 이상 항목 표(이름/값/단위/범위/방향/중증도)
  3) 임상 해석(빈혈/혈소판/염증 등 패턴)
  4) 권장 추가검사/관리(+긴급도)
  5) 한계/주의(불확실성)
  6) 근거 인용([문헌/가이드 섹션])

---

## 5. 컴포넌트와 코드 위치(가정)

- 규칙 엔진: `backend/app/services/analysis/clinical_rules.py`
- RAG 인덱서/리트리버: `backend/app/services/rag/indexer.py`, `backend/app/services/rag/retriever.py`
- 레퍼런스/단위/범위: `backend/app/services/analysis/reference/reference_data.py`
- 오케스트레이션: `frontend/services/orchestrator.py` (facts/evidence 주입 → compose)

---

## 6. 품질 보증(테스트/평가)

- 골든 셋(내부 샘플 PDF→정답 해석) 회귀 테스트
- 경계값/결측치/단위 흔들기 테스트
- 인간 평가(수의사 리뷰): 임상 타당성/톤/근거 충실도
- 메트릭
  - 수치·단위 불일치율, 근거 인용률, 규칙 일관성률, 응급 경고 누락률

---

## 7. 안전장치/컴플라이언스

- 응급 경계값 자동 경고(예: PLT<30K/µL, PCV<15%)
- 진단 고지: "정보 제공용, 최종 진단은 수의사의 진찰/추가검사로 확정"
- 민감 정보 마스킹(로그/메모리)

---

## 8. 데모 시나리오(예시)

1) 사용자가 혈액검사 PDF 업로드 → OCR로 MergeEnvelope 생성
2) 규칙 엔진이 이상 항목/패턴/권장 검사를 facts로 산출
3) RAG가 관련 가이드/논문 스니펫을 evidence로 제공
4) LLM이 수의사 톤으로 한국어 임상 설명 합성(요약/표/해석/권고/한계/인용)

---

## 9. 리스크 및 완화

- 범위/단위 다양성 → 규칙 엔진에서 단위 변환·범위 출처 메타로 완화
- 과도한 LLM 의존 → 판정은 규칙, LLM은 문장화 + 근거 인용으로 역할 제한
- 근거 부족 항목 → RAG 미스 시 "불확실/참고범위 없음"으로 투명하게 표기

---

## 10. 마일스톤(요약)

- M1: 규칙 엔진 초안(PLT/빈혈/WBC/신장) + facts 스키마
- M2: KB 인덱싱/리트리버 + evidence 스키마
- M3: 오케스트레이션 + 수의사 톤 템플릿 고정
- M4: 테스트/평가(골든 셋/경계값/인간 평가) + 운영 가이드

---

## 11. 의사코드(엔드투엔드)

```python
merge = extract_lab_report(paths)
facts = rule_engine(merge)  # 단일/조합 판정, 중증도, 추천검사
key_terms = facts.key_terms()
evidence = rag_search(key_terms)  # 가이드라인/논문 스니펫
final_text = compose_vet_style(merge.summary, facts, evidence)  # 한국어 임상 설명
```

---

## 12. 한 줄 요약

규칙으로 “판정의 일관성”을, RAG로 “신뢰 근거”를, LLM으로 “자연스러운 서술”을 책임 분담하여, 검사결과에서 수의사 수준의 설명을 안전하고 재현성 있게 생성합니다.
