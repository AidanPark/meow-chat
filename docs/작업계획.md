# 검사결과 데이터로 “수의사 수준” 설명을 생성하기 위한 작업계획서

본 문서는 이미지에서 추출된 검사결과(랩 리포트)를 바탕으로 수의사 수준의 설명을 안정적으로 생성하기 위한 설계와 구현 계획을 정리합니다. 목표는 숫자 해석의 신뢰성을 규칙으로 확보하고, 배경 설명은 문헌/가이드라인 근거를 인용(RAG)하며, LLM은 이 근거를 바탕으로 자연스러운 한국어 임상 설명만 담당하도록 분리하는 것입니다.

## 1) 목표와 성공 기준

- 목표
  - 추출된 랩 결과(MergeEnvelope JSON)로부터 수의사 수준의 해석(이상 판정, 병태생리 추정, 감별진단 후보, 권장 추가검사/관리)을 생성
  - 해석 문장에는 근거(수치/범위/규칙 및 가이드라인 인용)와 한계를 함께 제시
- 성공 기준
  - 동일 입력에 대해 반복 가능한(일관된) 판정
  - 수치/단위/참고범위 오독 최소화
  - 응급/중증 임계값에서 적시에 경고 문구 출력
  - 근거 인용(출처/섹션) 표기

## 2) 입력/출력 계약(Contract)

- 입력(JSON: MergeEnvelope)
  - stage: "merge"
  - data.merged: 문서/테스트 리스트
    - 문서 메타: hospital_name, patient_name, inspection_date, header_shape(선택)
    - tests: [{ code, value, unit, reference_min, reference_max, (선택) name, meaning }]
- 출력(최종 응답)
  - 상단 요약(핵심 결론 1–2문장)
  - 이상 항목 표(값/단위/참고범위/방향/중증도)
  - 임상 해석(병태생리/감별진단/연계 소견)
  - 권장 추가검사/관리(우선순위/긴급성)
  - 근거/한계(숫자·규칙·문헌 인용)
- 오류/엣지
  - 범위 누락: 판정 보류 + “출처 불명” 안내
  - 단위 의심: 변환 후보 제시(예: mg/dL vs mg/L)
  - 값 누락: 해당 항목은 “해석 불가(값 없음)” 표기

## 3) 파이프라인 개요(Flow)

1) 추출(extract_lab_report) → MergeEnvelope(JSON)
2) 규칙 기반 1차 해석(숫자/패턴 판정) → facts JSON
3) 근거 검색(RAG) → evidence JSON
4) LLM 합성(수의사 톤) → 최종 응답 텍스트

의사코드
```python
merge = extract_lab_report(paths)
facts = rule_engine(merge)  # 단일/조합 판정, 중증도, 추천검사
evidence = rag_search(facts.key_terms)  # 가이드라인/논문 스니펫
final = compose_vet_style(merge.summary, facts, evidence)  # 한국어 임상 설명
```

## 4) 규칙 기반 1차 해석(필수)

- 단일 항목 임계 판정
  - 예: PLT < min → ‘혈소판 감소증 의심’, HGB/HCT < min → ‘빈혈 의심’
- 조합 규칙(패턴)
  - RBC/HGB/HCT 동시 저하 + MCV/MCHC로 빈혈 형태 분류(소구성/대구성/저색소성 등)
  - WBC, NEUT/LYMPH/Mono 조합으로 염증/감염 방향성 추정
  - CREA/BUN/USG(있다면)로 신장 기능 이상/범주(전·신·후신성) 시사
- 중증도 등급(예시)
  - PLT: <50 K/µL(중증, 출혈 위험), 50–150(경~중등)
  - PCV/HCT: <15%(응급), 15–24%(중등도), 24–28%(경도)
- 결과 스키마(facts)
  - abnormalities: [{code, value, unit, ref_min, ref_max, direction, severity, notes}]
  - patterns: [{label, evidence_tests, confidence}]
  - recommendations: [{type: lab|imaging|history|exam, rationale, priority}]
  - caveats: [결측/단위의심/범위불명]

구현 위치 제안
- backend/app/services/analysis/clinical_rules.py (신규)
- backend/app/services/analysis/__init__.py 내 공개 엔트리 추가

## 5) RAG 기반 근거 인용(강력 권장)

- 컬렉션 소스(로컬 KB)
  - data/knowledge_base/guidelines, medical_papers, veterinary_docs
- 인덱싱
  - 문단/문장 단위 분할 → 임베딩 → 벡터 스토어(Chroma)
- 검색 쿼리
  - facts에서 key_terms 생성(예: “thrombocytopenia in cats”, “feline anemia classification”)
- 결과 스키마(evidence)
  - [{snippet, source, page_or_section, relevance}]
- 주의
  - 외부 웹 검색은 기본 비활성(안정성/비용/재현성). 필요한 경우만 opt-in

구현 위치 제안
- backend/app/services/rag/indexer.py, retriever.py (신규)
- 기존 Chroma 설정 재사용

## 6) 합성(Compose) 템플릿: 수의사 톤

- 입력
  - merge 요약(상위 30~50행 표)
  - facts(abnormalities/patterns/recs/caveats)
  - evidence(문헌 스니펫)
- 지침(요약)
  - 과장 금지, 숫자·단위·범위 정확히
  - 근거/한계/불확실성 명시(장비/검체/범위 출처 차이)
  - 동물이해자 관점: 위험도·우선순위·다음 행동 제시
- 출력 구성
  1) 핵심 요약(1–2문장)
  2) 이상 항목 표(이름/값/단위/범위/방향/중증도)
  3) 임상 해석(빈혈/혈소판/염증 등 패턴)
  4) 권장 추가검사/관리(+긴급도)
  5) 한계/주의(불확실성)
  6) 근거 인용([문헌/가이드 섹션])
- 프롬프트 샘플(요지)
  - “수의 내과 전문의로서 아래 JSON을 근거로 한국어 임상 설명을 작성하라… 숫자/단위/범위는 그대로, 추론은 facts+evidence로 한정, 인용은 괄호로 표기”

구현 위치 제안
- frontend/services/orchestrator.py 의 compose 노드에서 facts/evidence를 주입해 생성
- 또는 backend에서 초안 문구 생성 후 UI에서 최종 표+문장 결합

## 7) 레이블/사전/단위

- 코드→라벨 매핑
  - 한국어 meaning/영문 name: backend/app/services/analysis/reference/reference_data.py (REFERENCE_TESTS)
- 단위 정규화
  - 예: 10^3/µL ↔ K/µL, 10^6/µL ↔ M/µL
- 범위 표준화
  - 리포트 범위 우선, 없으면 내부 표준 범위(문헌 출처 메타 포함)

## 8) 안전장치/컴플라이언스

- 응급 경계값 자동 경고(PLT<30K/µL, PCV<15% 등)
- 진단 고지: “본 해석은 정보 제공용이며 최종 진단은 수의사의 진찰/추가검사로 확정”
- 민감 정보 마스킹(로그/메모리 저장)

## 9) 품질 보증(테스트/평가)

- 골든 셋(내부 샘플 PDF→정답 해석) 회귀 테스트
- 경계값/결측치/단위 흔들기 테스트
- 인간 평가(수의사 리뷰): 임상 타당성/톤/근거 충실도
- 메트릭
  - 수치·단위 불일치율, 근거 인용률, 규칙 일관성률, 응급 경고 누락률

## 10) 구현 계획(작업 리스트)

1) 규칙 엔진(backend)
   - [ ] clinical_rules.py 초안(PLT/빈혈/WBC 패턴/신장 탭)
   - [ ] 레퍼런스/범위/단위 유틸 정리
   - [ ] facts JSON 스키마 고정 및 테스트
2) RAG(backend)
   - [ ] KB 인덱싱 스크립트/리트리버
   - [ ] 키워드 생성/정규화(동의어 매핑) 유틸
   - [ ] evidence JSON 스키마/테스트
3) 오케스트레이터(frontend)
   - [ ] plan→execute 후 rules→rag→compose 순서로 확장
   - [ ] compose 템플릿(수의사 톤)과 표 렌더 고정
   - [ ] 내부 진행로그는 사이드바 갱신, 본문은 깔끔 유지
4) 장기 메모리
   - [ ] lab_report_json 저장 유지(원형), type="lab_report"
   - [ ] 과거 시계열 조회 유틸(특정 코드의 날짜-값)
5) 문서/운영
   - [ ] 본 문서/README 업데이트
   - [ ] 응급 경계값/표준 범위의 출처 테이블 작성

## 11) 리스크 및 완화

- 범위/단위 다양성 → 규칙 엔진에서 단위 변환·범위 출처 메타로 완화
- 과도한 LLM 의존 → 판정은 규칙, LLM은 문장화 + 근거 인용으로 역할 제한
- 근거 부족 항목 → RAG 미스 시 “불확실/참고범위 없음” 분리 표기

## 12) 운영 팁

- 오케스트레이터에 `_show_react_progress` 플래그로 내부 단계 노출 제어
- 긴 출력은 요약/표 우선, 상세는 “더 보기” 옵션(향후)
- 메모리 저장 후 업로드 자동 초기화(완료)

---
부록 A. 파일 경로 제안
- 규칙: `backend/app/services/analysis/clinical_rules.py`
- RAG: `backend/app/services/rag/indexer.py`, `retriever.py`
- 레퍼런스: `backend/app/services/analysis/reference/reference_data.py`
- 오케스트레이터: `frontend/services/orchestrator.py`

부록 B. 예시 키워드(Thrombocytopenia, Feline anemia, CBC interpretation, Azotemia workup)